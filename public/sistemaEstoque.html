<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <title>VTZ - Sistema Completo de Estoque de Sementes</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ==========================
   VTZ — FULL STYLE CSS Tem que fazer
   ========================== */

    /* Variáveis principais */
    :root {
      --green: #0e7a2a;
      --green-2: #0b5e20;
      --muted: #f5f7f9;
      --card: #ffffff;
      --danger: #ff6b6b;
      --warn: #ffa94d;
      --accent: #e8f5e9;
      --radius: 14px;
      --shadow-1: 0 6px 24px rgba(10, 10, 10, 0.08);
      --shadow-2: 0 12px 40px rgba(10, 10, 10, 0.12);
      --text: #222;
      --muted-text: #6b7280;
      --glass-bg: rgba(255, 255, 255, 0.28);
      --glass-border: rgba(255, 255, 255, 0.45);
      --glass-strong: rgba(255, 255, 255, 0.62);
      --glass-dim: rgba(255, 255, 255, 0.12);
      --mono: 'Courier New', monospace;
      --transition: 0.18s ease;
    }

    /* RESET / base */
    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #e9fbf0 0%, #f6fbfa 100%);
    }

    /* ====== HEADER TOPBAR ====== */
    header.topbar {
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 22px;
      gap: 12px;
      background: linear-gradient(90deg, #16a34a 0%, #0b5e20 100%);
      color: #fff;
      box-shadow: var(--shadow-2);
      position: sticky;
      top: 0;
      z-index: 1200;
    }

    /* Brand */
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 800;
      font-size: 18px;
      letter-spacing: 0.2px;
    }

    .brand .logo {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.14);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 18px;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    }

    /* Top actions */
    .top-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-chip {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .user-chip input {
      background: transparent;
      border: 0;
      outline: 0;
      color: white;
      font-weight: 700;
      width: 120px;
    }

    .top-actions .env-badge {
      font-weight: 700;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.06);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    /* ====== APP LAYOUT ====== */
    .app {
      display: flex;
      height: calc(100vh - 72px);
      gap: 18px;
    }

    aside.sidebar {
      width: 300px;
      padding: 18px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-right: 1px solid var(--glass-border);
      border-radius: 0 10px 10px 0;
      box-shadow: 0 4px 18px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    main.content {
      flex: 1;
      padding: 24px;
      overflow: auto;
    }

    /* Sidebar pieces */
    .side-title {
      font-size: 13px;
      font-weight: 800;
      color: var(--green-2);
      margin-bottom: 6px;
    }

    .card-compact {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.36), rgba(255, 255, 255, 0.22));
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-1);
    }

    .card-compact small {
      color: var(--muted-text);
      display: block;
      margin-top: 6px;
      font-size: 13px;
    }

    /* alerts list */
    .alerts-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 220px;
      overflow: auto;
      padding-right: 4px;
    }

    .alert-item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.46), rgba(255, 255, 255, 0.30));
      padding: 10px;
      border-radius: 10px;
      border-left: 6px solid rgba(255, 255, 255, 0.12);
      font-size: 13px;
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition);
    }

    .alert-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06);
    }

    .alert-item.low {
      border-left-color: var(--danger);
    }

    /* vermelho */
    .alert-item.warn {
      border-left-color: var(--warn);
    }

    /* amarelo */
    .alert-item.ok {
      border-left-color: var(--green);
    }

    /* verde */

    /* sales list */
    .sales-list {
      max-height: 160px;
      overflow: auto;
      padding: 8px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.36), rgba(255, 255, 255, 0.2));
      border: 1px solid var(--glass-border);
    }

    /* KPI row */
    .kpi-row {
      display: flex;
      gap: 14px;
      margin-bottom: 18px;
    }

    .kpi {
      flex: 1;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.36), rgba(255, 255, 255, 0.22));
      padding: 14px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-1);
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
    }

    .kpi .label {
      font-size: 13px;
      color: var(--muted-text);
    }

    .kpi .value {
      font-size: 22px;
      font-weight: 900;
      color: var(--green-2);
    }

    /* ===== CONTROLS / SEARCH / ACTIONS ===== */
    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .search {
      display: flex;
      align-items: flex-start ;
      gap: 250px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.36), rgba(255, 255, 255, 0.22));
      border: 1px solid var(--glass-border);
      padding: 10px 09% ;
      border-radius: 999px;
      min-width: 240px;
      max-width: 540px;
      box-shadow: var(--shadow-1);
    }

    .search svg {
      opacity: 0.7
    }

    .search input {
      border: 0;
      background: transparent;
      outline: 0;
      font-size: 14px;
      min-width: 120px;
      align-items: flex-start ;
    }

    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Buttons */
    .btn {
      padding: 9px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      cursor: pointer;
      font-weight: 800;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      background: rgba(255, 255, 255, 0.6);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--green), var(--green-2));
      color: #fff;
      border: none;
    }

    .btn-primary:hover {
      filter: brightness(1.03);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(15, 15, 15, 0.05);
      color: var(--text);
    }

    .btn-warn {
      background: linear-gradient(90deg, #ffb86b, #ff8a4d);
      color: #fff;
      border: none;
    }

    /* ===== LIST (principal) ===== */
    .list-section {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.36), rgba(255, 255, 255, 0.26));
      border: 1px solid var(--glass-border);
      padding: 14px;
      border-radius: 12px;
      box-shadow: var(--shadow-2);
      backdrop-filter: blur(12px);
    }

    /* grid header: mantenho mesma template-columns para alinhamento */
    .list-header {
      display: grid;
      grid-template-columns: 48px 120px 1fr 120px 100px 120px 120px 120px 160px;
      gap: 10px;
      align-items: center;
      font-weight: 800;
      background: linear-gradient(90deg, rgba(11, 94, 32, 0.95), rgba(14, 122, 42, 0.95));
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(8, 60, 20, 0.12);
    }

    .list-header div {
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* product rows */
    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .row-card {
      display: grid;
      grid-template-columns: 48px 120px 1fr 120px 100px 120px 120px 120px 160px;
      gap: 10px;
      align-items: center;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.36), rgba(255, 255, 255, 0.20));
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-1);
      transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    .row-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 40px rgba(10, 10, 10, 0.12);
      background: rgba(255, 255, 255, 0.52);
    }

    /* coluna index + imagem + texto */
    .index-pill {
      background: linear-gradient(180deg, rgba(22, 163, 74, 0.12), rgba(22, 163, 74, 0.07));
      color: var(--green-2);
      padding: 6px;
      border-radius: 8px;
      font-weight: 800;
      text-align: center;
      font-size: 13px;
    }

    .thumb img {
      width: 72px;
      height: 48px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--glass-border);
    }

    /* nome coluna e inputs inline */
    .col {
      overflow: hidden;
    }

    .col input {
      border: 0;
      background: transparent;
      width: 100%;
      outline: 0;
      font-weight: 700;
      font-size: 14px;
    }

    .col input[type="date"] {
      font-weight: 600;
      color: var(--green-2);
    }

    /* unidade / local / codigo etc (consistência) */
    .row-card .col small {
      display: block;
      color: var(--muted-text);
      font-weight: 600;
      font-size: 12px;
    }

    /* qtd / ações */
    .qty {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .qty button {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(90deg, var(--green), var(--green-2));
      color: #fff;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    }

    .qty button:hover {
      transform: translateY(-2px);
    }

    /* gear actions */
    .gear {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0.22));
      border: 1px solid var(--glass-border);
      cursor: pointer;
    }

    /* small helpers */
    .small-muted {
      font-size: 12px;
      color: var(--muted-text);
    }

    /* ===== MODALS (todos) ===== */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.35);
      z-index: 1400;
      backdrop-filter: blur(8px);
    }

    .modal .card {
      width: 640px;
      max-width: 94%;
      max-height: 86vh;
      overflow: auto;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.38), rgba(255, 255, 255, 0.24));
      border-radius: 14px;
      border: 1px solid var(--glass-border);
      padding: 22px;
      box-shadow: var(--shadow-2);
      backdrop-filter: blur(12px);
      animation: modalPop 210ms cubic-bezier(.2, .8, .2, 1);
    }

    @keyframes modalPop {
      from {
        transform: scale(0.96);
        opacity: 0
      }

      to {
        transform: scale(1);
        opacity: 1
      }
    }

    /* modal titles/labels/inputs */
    .modal .card h3 {
      color: var(--green-2);
      margin: 0 0 10px 0;
      font-size: 20px;
      border-bottom: 2px solid rgba(22, 163, 74, 0.12);
      padding-bottom: 8px;
    }

    .modal .card label {
      display: block;
      font-weight: 800;
      color: var(--green-2);
      margin-top: 8px;
    }

    .modal .card input,
    .modal .card select,
    .modal .card textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      margin-top: 6px;
      background: rgba(255, 255, 255, 0.9);
      outline: none;
    }

    .modal .card input:focus,
    .modal .card textarea:focus {
      box-shadow: 0 8px 30px rgba(14, 122, 42, 0.08);
      border-color: var(--green-2);
    }

    /* specific smaller modals */
    #modalAdd .card {
      width: 520px;
    }

    #modalSell .card {
      width: 520px;
    }

    #modalDetails .card {
      width: 720px;
    }

    /* login overlay */
    #modalLoginOverlay .card {
      text-align: center;
      min-width: 360px;
    }

    /* import modal (revisão de import) - tabela */
    #importModal,
    #importModal {
      /* older names can be used */
      /* handled by .modal */
    }

    #importTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 10px;
    }

    #importTable thead th {
      background: rgba(255, 255, 255, 0.12);
      padding: 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      text-align: left;
    }

    #importTable tbody tr {
      background: rgba(255, 255, 255, 0.45);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    #importTable tbody td {
      padding: 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      vertical-align: middle;
    }

    #importTable tbody tr.dup {
      background: linear-gradient(90deg, rgba(255, 243, 205, 0.6), rgba(255, 255, 255, 0.4));
    }

    /* action buttons inside import modal */
    #importTable .btn {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 8px;
    }

    #importTable .btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* ===== LOGS ===== */
    .logs {
      margin-top: 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.36), rgba(255, 255, 255, 0.22));
      border-radius: 12px;
      padding: 12px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-1);
      max-height: 320px;
      overflow: auto;
    }

    .logs .log-item {
      background: rgba(255, 255, 255, 0.46);
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 8px;
      border-left: 6px solid rgba(0, 0, 0, 0.06);
      font-size: 13px;
    }

    .logs .log-item.add {
      border-left-color: var(--green);
    }

    .logs .log-item.update {
      border-left-color: var(--warn);
    }

    .logs .log-item.delete {
      border-left-color: var(--danger);
    }

    /* small text */
    .small-muted {
      color: var(--muted-text);
      font-size: 12px;
    }

    /* footer */
    footer {
      margin-top: 18px;
      text-align: center;
      color: var(--muted-text);
      font-size: 13px;
    }

    /* ===== TINY UI HELPERS ===== */
    .badge {
      display: inline-block;
      padding: 6px 8px;
      border-radius: 999px;
      font-weight: 800;
      background: rgba(255, 255, 255, 0.32);
      border: 1px solid var(--glass-border);
    }

    .h-chip {
      font-size: 13px;
      color: var(--muted-text)
    }

    /* disabled / readonly states for inputs */
    input[readonly],
    input[disabled],
    textarea[disabled] {
      opacity: 0.8;
      background: rgba(240, 240, 240, 0.4);
      pointer-events: none;
    }

    /* responsive adjustments */
    @media (max-width:1100px) {
      aside.sidebar {
        display: none;
      }

      .app {
        height: calc(100vh - 72px);
        overflow: auto;
      }

      .list-header,
      .row-card {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        text-align: left;
      }

      .row-card {
        padding: 12px;
      }

      .thumb img {
        width: 56px;
        height: 40px;
      }

      .kpi-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .modal .card {
        width: 92%;
      }
    }

    @media (max-width:720px) {
      header.topbar {
        padding: 0 12px;
      }

      .brand .logo {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }

      .search {
        min-width: unset;
        flex: 1;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .actions {
        justify-content: flex-end;
      }

      .row-card {
        grid-template-columns: 1fr 1fr;
      }

      .list-header {
        display: none;
      }
    }

    /* accessibility & focus styles */
    :focus {
      outline: 3px solid rgba(14, 122, 42, 0.12);
      outline-offset: 2px;
    }

    /* subtle animation for new logs */
    @keyframes newLogPulse {
      0% {
        transform: translateY(0);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      }

      50% {
        transform: translateY(-3px);
        box-shadow: 0 16px 36px rgba(0, 0, 0, 0.10);
      }

      100% {
        transform: translateY(0);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      }
    }

    /* utility for highlighted rows (e.g. expiring soon) */
    .row-highlight-expire {
      box-shadow: 0 12px 36px rgba(255, 150, 0, 0.06);
      border-left: 4px solid rgba(255, 150, 0, 0.14);
    }

    .row-highlight-low {
      box-shadow: 0 12px 36px rgba(255, 100, 100, 0.06);
      border-left: 4px solid rgba(255, 100, 100, 0.14);
    }

    /* ensure file input invisible but reachable */
    input[type="file"] {
      display: none;
    }

    /* keep tables tidy inside modals */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th,
    td {
      padding: 8px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.04)
    }

    /* ===== MODAL: DETALHES DO PRODUTO ===== */
    #modalDetails .card {
      background: #ffffff;
      color: #1a1a1a;
      border: 1px solid #e6e6e6;
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.25);
      backdrop-filter: none;
    }

    #modalDetails .card h3 {
      color: var(--green-dark);
      font-size: 22px;
      font-weight: 800;
      border-bottom: 2px solid #e8f5e9;
      padding-bottom: 8px;
      margin-bottom: 16px;
    }

    #modalDetails .card label {
      color: var(--green-2);
      font-weight: 700;
      margin-top: 8px;
    }

    #modalDetails .card input,
    #modalDetails .card textarea {
      background: #f9faf9;
      border: 1px solid #cfd8dc;
      border-radius: 10px;
      padding: 10px 12px;
      width: 100%;
      font-size: 14px;
      color: #333;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    #modalDetails .card input:focus,
    #modalDetails .card textarea:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(14, 122, 42, 0.15);
    }

    /* botão de fechar / ações do modal */
    #modalDetails .card .btn-primary {
      background: var(--green);
      color: #fff;
      border-radius: 10px;
      font-weight: 800;
      transition: all 0.2s;
    }

    #modalDetails .card .btn-primary:hover {
      background: #0b6a24;
      transform: scale(1.03);
    }

    /* ===== MODAL: ADICIONAR PRODUTO ===== */
    #modalAdd .card {
      background: #ffffff;
      /* fundo sólido */
      color: #1a1a1a;
      border: 1px solid #e6e6e6;
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.25);
      backdrop-filter: none;
      /* remove o vidro */
    }

    #modalAdd .card h3 {
      color: var(--green-dark);
      font-size: 22px;
      font-weight: 800;
      border-bottom: 2px solid #e8f5e9;
      padding-bottom: 8px;
      margin-bottom: 16px;
    }

    #modalAdd .card label {
      color: var(--green-2);
      font-weight: 700;
      margin-top: 8px;
    }

    #modalAdd .card input,
    #modalAdd .card select,
    #modalAdd .card textarea {
      background: #f9faf9;
      border: 1px solid #cfd8dc;
      border-radius: 10px;
      padding: 10px 12px;
      width: 100%;
      font-size: 14px;
      color: #333;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    #modalAdd .card input:focus,
    #modalAdd .card select:focus,
    #modalAdd .card textarea:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(14, 122, 42, 0.15);
    }

    #modalAdd .card .btn-primary {
      background: var(--green);
      color: white;
      border-radius: 10px;
      font-weight: 800;
      padding: 10px 14px;
      transition: all 0.2s;
    }

    #modalAdd .card .btn-primary:hover {
      background: #0b6a24;
      transform: scale(1.03);
    }

    #modalAdd .card .btn-ghost {
      background: #f4f7f4;
      border: 1px solid #dce7dc;
      color: #333;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      transition: all 0.2s;
    }

    #modalAdd .card .btn-ghost:hover {
      background: #e8f5e9;
    }

    /* ===== MODAL: REGISTRAR VENDA ===== */
    #modalSell .card {
      background: #ffffff;
      /* fundo sólido para leitura */
      color: #1a1a1a;
      border: 1px solid #e6e6e6;
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
      padding: 24px;
      max-height: 85vh;
      overflow-y: auto;
      backdrop-filter: none;
      animation: modalPopSolid 0.25s ease-out;
    }

    @keyframes modalPopSolid {
      from {
        transform: scale(0.95);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    #modalSell .card h3 {
      color: var(--green-dark);
      font-size: 22px;
      font-weight: 800;
      border-bottom: 2px solid #e8f5e9;
      padding-bottom: 8px;
      margin-bottom: 16px;
    }

    #modalSell .card label {
      display: block;
      font-weight: 700;
      color: var(--green-2);
      margin-top: 10px;
      font-size: 14px;
    }

    #modalSell .card input,
    #modalSell .card select,
    #modalSell .card textarea {
      background: #f9faf9;
      border: 1px solid #cfd8dc;
      border-radius: 10px;
      padding: 10px 12px;
      width: 100%;
      font-size: 14px;
      color: #333;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      margin-top: 6px;
    }

    #modalSell .card input:focus,
    #modalSell .card select:focus,
    #modalSell .card textarea:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(14, 122, 42, 0.15);
    }

    /* Botões principais (Registrar, Confirmar, etc.) */
    #modalSell .card .btn-primary {
      background: var(--green);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 800;
      padding: 10px 16px;
      transition: all 0.2s ease;
    }

    #modalSell .card .btn-primary:hover {
      background: #0b6a24;
      transform: scale(1.03);
    }

    /* Botões secundários (Cancelar, Fechar, etc.) */
    #modalSell .card .btn-ghost {
      background: #f4f7f4;
      border: 1px solid #dce7dc;
      color: #333;
      border-radius: 10px;
      font-weight: 700;
      padding: 10px 16px;
      transition: all 0.2s ease;
    }

    #modalSell .card .btn-ghost:hover {
      background: #e8f5e9;
    }

    /* Botão de fechar no canto */
    #modalSell .close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #f0f3f0;
      border-radius: 50%;
      border: 1px solid #dce7dc;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #modalSell .close-btn:hover {
      background: #e8f5e9;
      transform: rotate(90deg);
    }

    /* ===== ALERTAS ===== */
    .alerts-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 250px;
      overflow-y: auto;
    }

    .alert-item {
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.25s ease;
      border-left: 5px solid transparent;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Cores por tipo de alerta */
    .alert-item.low {
      background: #fff5f5;
      border-left-color: #ff4d4f;
      color: #b30000;
    }

    .alert-item.expiring {
      background: #fff8e1;
      border-left-color: #ffc107;
      color: #a67c00;
    }

    .alert-item.ok {
      background: #f0fff4;
      border-left-color: #22c55e;
      color: #136b3b;
    }

    /* Hover */
    .alert-item:hover {
      transform: translateX(4px);
      filter: brightness(1.05);
    }

    /* Estado ativo (quando clicado/filtrando) */
    .alert-item.active {
      background: linear-gradient(90deg, #d9f99d, #bbf7d0);
      border-left-color: #16a34a;
      color: #0a4a2b;
      box-shadow: 0 0 10px rgba(22, 163, 74, 0.3);
    }

    /* ===== HISTÓRICO DE VENDAS ===== */
    .sales-list {
      background: #ffffffaa;
      backdrop-filter: blur(6px);
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      padding: 12px;
      max-height: 260px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
    }

    .sale-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f9fff9;
      padding: 10px 14px;
      border-radius: 10px;
      border-left: 5px solid var(--green);
      transition: all 0.2s;
    }

    .sale-item:hover {
      background: #e8f5e9;
      transform: translateX(4px);
    }

    .sale-info {
      display: flex;
      flex-direction: column;
    }

    .sale-info strong {
      color: var(--green-2);
      font-size: 15px;
    }

    .sale-info small {
      color: #555;
      font-size: 13px;
    }

    .sale-client {
      color: #0b6a24;
      font-weight: 700;
      background: #dcfce7;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 13px;
    }


    /* END OF STYLE */
  </style>



</head>

<body>

  <header class="topbar">
    <div class="brand">
      <div class="logo">VTZ</div>
      <div>VTZ Agronegócios — Estoque de Sementes</div>
    </div>

    <div class="top-actions">
      <div class="user-chip" title="Usuário atual (alterar para registrar logs)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:0.9">
          <circle cx="12" cy="8" r="3" stroke="white" stroke-width="1.6" />
          <path d="M6 20c0-3.3 2.7-6 6-6s6 2.7 6 6" stroke="white" stroke-width="1.6" stroke-linecap="round" />
        </svg>
        <input id="usuarioAtualHeader" value="admin" />
        <button id="btnLogout" class="btn btn-ghost" style="padding:6px 8px;margin-left:6px"
          onclick="logout()">Sair</button>
      </div>

      <div
        style="color:rgba(255,255,255,0.95);font-weight:700;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.05)">
        Ambiente: Demo
      </div>
    </div>
  </header>

  <div class="app">
    <aside class="sidebar">
      <div class="side-title">Visão Geral</div>

      <div class="card-compact">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:20px;font-weight:900" id="sideTotalCount">0</div>
            <small>Produtos cadastrados</small>
          </div>
          <div style="text-align:right">
            <div id="sideTotalQty" style="font-weight:900;color:var(--green)">0</div>
            <small style="color:var(--muted-text)">Total unidades</small>
          </div>
        </div>
      </div>

      <div class="card-compact">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:18px;font-weight:900" id="sideLowCount">0</div>
            <small>Itens com baixo estoque</small>
          </div>
          <div style="text-align:right">
            <div id="sideExpireCount" style="font-weight:900;color:var(--warn)">0</div>
            <small style="color:var(--muted-text)">Próx. a vencer</small>
          </div>
        </div>
      </div>

      <div class="side-title">Alertas (click para filtrar)</div>
      <div class="alerts-list" id="alertsList"></div>

      <div class="side-title" style="margin-top:8px">Histórico de Vendas</div>
      <div class="sales-list" id="salesList"></div>

      <div style="margin-top:6px;font-size:12px;color:var(--muted-text)">Logs aparecem no painel principal (últimas
        ações).</div>
    </aside>

    <main class="content">
      <div class="kpi-row">
        <div class="kpi">
          <div class="label">Produtos cadastrados</div>
          <div class="value" id="cardProducts">0</div>
        </div>
        <div class="kpi">
          <div class="label">Baixo estoque</div>
          <div class="value" id="cardLow">0</div>
        </div>
        <div class="kpi">
          <div class="label">Próximos a vencer (30 dias)</div>
          <div class="value" id="cardExpire">0</div>
        </div>
      </div>
      <!--Barra de Pesquisa cuidado com oninput-->
      <div class="controls">
        <div class="search">
          </svg>
          <input id="searchInput" placeholder="🔍 Buscar por nome, código, validade..." oninput="onSearch()" />
        </div>

        <div class="actions">
          <button class="btn btn-primary" onclick="openAddModal()">+ Adicionar</button>
          <button class="btn btn-ghost" onclick="exportCSV()">Exportar CSV</button>
          <button class="btn btn-ghost" onclick="exportJSON()">Exportar JSON</button>
          <button class="btn btn-ghost" onclick="exportPDF()">Exportar PDF</button>
          <button class="btn btn-ghost" onclick="exportLogsPDF()">Exportar Logs PDF</button>
          <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none" />
          <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none" />
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btn-ghost" onclick="document.getElementById('excelInput').click()">📤 Importar
              Excel</button>
            <button class="btn btn-ghost" onclick="downloadExcelTemplate()">📥 Baixar Modelo Excel</button>
          </div>
        </div>
      </div>
      <!-- 🧩 Modal de revisão de importação -->
      <div id="importModal" class="modal" style="display:none;">
        <div class="card" style="max-width:900px;width:95%;max-height:90vh;overflow:auto;">
          <h2 style="margin-top:0;">📦 Revisar Importação de Excel</h2>
          <p>Revise os produtos abaixo antes de confirmar a importação:</p>
          <table id="importTable" style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead style="background:#e8f5e9;">
              <tr>
                <th>Nome</th>
                <th>Peso</th>
                <th>Local</th>
                <th>Código</th>
                <th>Validade</th>
                <th>Qtd. Excel</th>
                <th>Status</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div style="margin-top:15px;text-align:right;">
            <button class="btn btn-ghost" onclick="closeImportModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmImportChanges()">Confirmar Importação</button>
          </div>
        </div>
      </div>

      <!-- Cabeçalho das colunas -->
      <div class="list-header">
        <div>#</div>
        <div>Imagem</div>
        <div>Nome</div>
        <div>Quantidade</div>
        <div>Localização</div>
        <div>Código</div>
        <div>Entrada</div>
        <div>Validade</div>
        <div>Qtd / Ações</div>
      </div>

      <!-- Lista dos produtos -->
      <div class="list" id="productList"></div>

      <div class="logs" style="margin-top:14px">
        <strong>📜 Logs de Ações</strong>
        <div id="logList" style="margin-top:8px; max-height:300px; overflow:auto;"></div>
      </div>

      <footer>VTZ Agronegócios • Protótipo • Dados armazenados em localStorage</footer>
    </main>
  </div>

  <!-- MODALS -->
  <div class="modal" id="modalAdd">
    <div class="card">
      <h3 id="modalAddTitle">Adicionar Produto</h3>
      <div style="display:grid;gap:10px;margin-top:10px">
        <label><strong>Nome do produto</strong></label>
        <input id="field_nome" placeholder="Ex: Milho (saco)" />
        <label><strong>Peso / Unidade</strong></label>
        <input id="field_peso" placeholder="Ex: 10 KG" />
        <label><strong>Localização</strong></label>
        <input id="field_local" placeholder="Ex: N1" />
        <label><strong>Código</strong> <small style="color:var(--muted-text)">(SKU)</small></label>
        <input id="field_codigo" placeholder="Ex: 725156365" />
        <div style="display:flex;gap:8px">
          <div style="flex:1">
            <label>Data de entrada</label>
            <input id="field_entrada" type="date" />
          </div>
          <div style="flex:1">
            <label>Validade</label>
            <input id="field_validade" type="date" />
          </div>
        </div>
        <label><strong>Quantidade</strong></label>
        <input id="field_quantidade" type="number" min="0" value="1" />
        <label>URL da Imagem (opcional)</label>
        <input id="field_imagem" placeholder="https://..." oninput="previewProductImage(this.value)" />

        <div id="previewBox" style="display:flex;justify-content:center;margin-top:10px;">
          <img id="previewImg" src="" alt="Pré-visualização"
            style="max-width:180px;max-height:120px;border-radius:10px;display:none;">
        </div>
        <input id="field_imagem" placeholder="https://..." />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn btn-primary" onclick="saveProduct()">Salvar</button>
          <button class="btn btn-ghost" onclick="closeAddModal()">Cancelar</button>
        </div>
        <div style="font-size:12px;color:var(--muted-text);margin-top:8px">
          Observação: se já existir um produto com mesmo <strong>Nome + Código + Localização</strong>, você será
          perguntado se deseja somar quantidades ou criar um novo lote.
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalDetails">
    <div class="card" id="modalDetailsCard">
      <h3 id="modalDetailsTitle">Detalhes do Produto</h3>
      <div id="modalDetailsBody" style="display:flex;flex-direction:column;gap:8px;margin-top:10px"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-ghost" onclick="closeDetailsModal()">Fechar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalSell">
    <div class="card">
      <h3>Registrar Venda</h3>
      <div style="display:grid;gap:8px;margin-top:8px">
        <label>Produto</label>
        <input id="sellItemInfo" readonly
          style="background:#fafafa;padding:8px;border-radius:8px;border:1px dashed #eee" />
        <label>Quantidade</label>
        <input id="sellQty" type="number" min="1" value="1" />
        <label>Nome da Empresa / Pessoa</label>
        <input id="sellBuyer" placeholder="Empresa ABC" />
        <label>CPF / CNPJ</label>
        <input id="sellDoc" placeholder="000.000.000-00 ou 00.000.000/0001-00" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn btn-primary" onclick="confirmSell()">Confirmar Venda</button>
          <button class="btn btn-ghost" onclick="closeSellModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalLoginOverlay" style="display:none;">
    <div class="card" style="min-width:360px; max-width:420px; text-align:center">
      <h2 style="margin:0 0 8px 0; color:var(--green)">VTZ • Acesso</h2>
      <p style="color:var(--muted-text); margin:0 0 12px 0">Faça login para acessar o sistema. Usuário padrão:
        <strong>admin</strong> / senha: <strong>1234</strong>
      </p>
      <div style="display:grid;gap:8px">
        <input id="loginUser" placeholder="Usuário" />
        <input id="loginPass" type="password" placeholder="Senha" />
        <div style="display:flex;gap:8px;justify-content:center">
          <button class="btn btn-primary" onclick="doLogin()">Entrar</button>
          <button class="btn btn-ghost" onclick="fillDemoLogin()">Demo</button>
        </div>
      </div>
      <div style="margin-top:10px;font-size:12px;color:var(--muted-text)">Este protótipo salva dados no seu navegador
        (localStorage).</div>
    </div>
  </div>
  <!-- Scripts externos -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>

  <script>
    // -----------------------
    // Lógica principal (completa)
    // -----------------------
    function uid(prefix = 'id') { return prefix + '_' + Math.random().toString(36).slice(2, 10); }
    const KEY_PRODUCTS = 'vtz_produtos';
    const KEY_LOGS = 'vtz_logs';
    const KEY_SALES = 'vtz_vendas';

    let products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || 'null') || [];
    let logs = JSON.parse(localStorage.getItem(KEY_LOGS) || 'null') || [];
    let sales = JSON.parse(localStorage.getItem(KEY_SALES) || 'null') || [];

    let storedUser = localStorage.getItem('vtz_user');
    let currentUser = storedUser || (document.getElementById('usuarioAtualHeader') && document.getElementById('usuarioAtualHeader').value) || 'admin';
    let currentSearch = '';
    let currentDetailProductIndex = null;
    let sellingIndex = null;
    let editingIndex = null;

    function persistAll() {
      localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
      localStorage.setItem(KEY_LOGS, JSON.stringify(logs));
      localStorage.setItem(KEY_SALES, JSON.stringify(sales));
    }

    function esc(s) { if (s === null || s === undefined) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    function addLogStructured(type, message, before = null, after = null, meta = null) {
      const entry = { id: uid('log'), ts: new Date().toISOString(), user: currentUser, type, message, before, after, meta };
      logs.unshift(entry);
      if (logs.length > 1000) logs.length = 1000;
      persistAll();
      renderLogs();
    }
    function addLog(msg) { addLogStructured('info', msg); }

    function renderLogs() {
      const el = document.getElementById('logList');
      if (!el) return;
      el.innerHTML = logs.map(l => {
        const time = (new Date(l.ts)).toLocaleString();
        let extra = '';
        if (l.before !== null || l.after !== null) {
          extra = `<div style="font-family:var(--mono);color:#333;margin-top:6px;font-size:12px">Antes: ${esc(String(l.before || ''))} → Depois: ${esc(String(l.after || ''))}</div>`;
        }
        return `<div style="padding:8px;border-bottom:1px dashed #f0f0f0">
                <div style="font-size:13px"><strong>${esc(l.user)}</strong> • ${esc(l.type)} • <small style="color:#007bff; font-weight:bold;">${time}</small></div>
                <div style="margin-top:6px">${esc(l.message)}</div>
                ${extra}
              </div>`;
      }).join('');
    }

    function updateDashboard() {
      document.getElementById('cardProducts').innerText = products.length;
      document.getElementById('sideTotalCount').innerText = products.length;
      const totalQty = products.reduce((a, b) => a + (b.quantidade || 0), 0);
      document.getElementById('sideTotalQty').innerText = totalQty;
      // low stock threshold
      const lowThreshold = 5;
      const lowCount = products.filter(p => (p.quantidade || 0) <= lowThreshold).length;
      const expireCount = products.filter(p => {
        if (!p.validade) return false;
        const diff = (new Date(p.validade) - new Date()) / (1000 * 60 * 60 * 24);
        return diff >= 0 && diff <= 30;
      }).length;
      document.getElementById('sideLowCount').innerText = lowCount;
      document.getElementById('cardLow').innerText = lowCount;
      document.getElementById('sideExpireCount').innerText = expireCount;
      document.getElementById('cardExpire').innerText = expireCount;
    }

    function updateAlertsAndSales() {
      const alertsEl = document.getElementById('alertsList');
      alertsEl.innerHTML = '';
      const lowThreshold = 5;
      const lowItems = products.filter(p => (p.quantidade || 0) <= lowThreshold);
      const soonExpire = products.filter(p => {
        if (!p.validade) return false;
        const diff = (new Date(p.validade) - new Date()) / (1000 * 60 * 60 * 24);
        return diff >= 0 && diff <= 30;
      });
      const items = [];
      lowItems.slice(0, 5).forEach(p => {
        const div = document.createElement('div');
        div.className = 'alert-item';
        div.innerText = `Baixo estoque: ${p.nome} • ${p.quantidade || 0} unidades`;
        div.onclick = () => { currentSearch = p.nome; document.getElementById('searchInput').value = p.nome; renderProductList(p.nome); };
        alertsEl.appendChild(div);
      });
      soonExpire.slice(0, 5).forEach(p => {
        const div = document.createElement('div');
        div.className = 'alert-item';
        div.innerText = `Vence em breve: ${p.nome} • validade: ${p.validade || '-'}`;
        div.onclick = () => { currentSearch = p.nome; document.getElementById('searchInput').value = p.nome; renderProductList(p.nome); };
        alertsEl.appendChild(div);
      });

      // sales list
      const salesEl = document.getElementById('salesList');
      salesEl.innerHTML = '';
      sales.slice(0, 8).forEach(s => {
        const d = document.createElement('div');
        d.style.padding = '6px';
        d.style.borderBottom = '1px dashed #eee';
        d.innerHTML = `<div style="font-weight:800">${esc(s.produto)}</div><small style="color:var(--muted-text)">${new Date(s.ts).toLocaleString()}</small>`;
        salesEl.appendChild(d);
      });
    }

    function renderProductList(filterText = '') {
      const listEl = document.getElementById('productList');
      listEl.innerHTML = '';
      const normalizedFilter = (filterText || currentSearch || '').trim().toLowerCase();
      products.forEach((p, idx) => {
        if (normalizedFilter) {
          const hay = `${p.nome} ${p.codigo || ''} ${p.localizacao || ''}`.toLowerCase();
          if (!hay.includes(normalizedFilter)) return;
        }
        const div = document.createElement('div');
        div.className = 'row-card';
        div.onclick = () => openDetails(idx);
        div.innerHTML = `
        <div class="index-pill" title="Índice">${idx + 1}</div>
        <div class="thumb"><img title="Imagem do produto" src="${esc(p.imagem) || 'https://via.placeholder.com/140x90?text=SEM'}" alt="${esc(p.nome)}" /></div>
        <div class="col"><input title="Nome do produto" value="${esc(p.nome)}" onchange="onInlineEdit(${idx}, 'nome', this.value)" /></div>
        <div class="col"><input title="Unidade de medida" value="${esc(p.peso || '')}" onchange="onInlineEdit(${idx}, 'peso', this.value)" /></div>
        <div class="col"><input title="Localização" value="${esc(p.localizacao || '')}" onchange="onInlineEdit(${idx}, 'localizacao', this.value)" /></div>
        <div class="col"><input title="Código do produto" value="${esc(p.codigo || '')}" onchange="onInlineEdit(${idx}, 'codigo', this.value)" /></div>
        <div class="col"><input title="Entrada no estoque" type="date" value="${esc(p.entrada || '')}" onchange="onInlineEdit(${idx}, 'entrada', this.value)" /></div>
        <div class="col"><input title="Validade" type="date" value="${esc(p.validade || '')}" onchange="onInlineEdit(${idx}, 'validade', this.value)" /></div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:center">
          <div class="qty">
            <button title="Diminuir" onclick="adjustQty(${idx}, -1)">-</button>
            <div style="min-width:20px;text-align:center;font-weight:500">${p.quantidade || 0}</div>
            <button title="Aumentar" onclick="adjustQty(${idx}, 1)">+</button>
          </div>
          <div style="display:flex;gap:6px;margin-top:6px">
            <div class="gear" title="Detalhar" onclick="openDetails(${idx})">🔎</div>
            <div class="gear" title="Vender" onclick="openSell(${idx})">💰</div>
            <div class="gear" title="Remover" onclick="removeProduct(${idx})">🗑️</div>
          </div>
        </div>
      `;
        listEl.appendChild(div);
      });
      updateDashboard();
      updateAlertsAndSales();
      persistAll();
    }

    function onInlineEdit(index, field, newValue) {
      const product = products[index];
      const before = product[field];
      const value = (field === 'quantidade') ? (parseInt(newValue) || 0) : newValue;
      product[field] = value;
      addLogStructured('edit', `Editou campo "${field}" do produto "${product.nome}"`, before, value, { productId: product.id });
      persistAll();
      renderProductList(currentSearch);
    }

    function adjustQty(index, delta) {
      const product = products[index];
      const before = product.quantidade || 0;
      let after = before + delta;
      if (after < 0) after = 0;
      product.quantidade = after;
      addLogStructured('quantidade', `Alterou quantidade de "${product.nome}"`, before, after, { productId: product.id });
      persistAll();
      renderProductList(currentSearch);
      updateAlertsAndSales();
    }

    function removeProduct(index) {
      const p = products[index];
      if (!confirm(`Confirmar remoção do produto "${p.nome}" (código: ${p.codigo || '—'})?`)) return;
      products.splice(index, 1);
      addLogStructured('remover', `Removeu produto "${p.nome}"`, null, null, { productId: p.id });
      persistAll();
      renderProductList(currentSearch);
      renderLogs();
    }

    function openAddModal(editIdx = null) {
      editingIndex = (typeof editIdx === 'number') ? editIdx : null;
      document.getElementById('modalAddTitle').innerText = editingIndex === null ? 'Adicionar Produto' : 'Editar Produto';
      if (editingIndex !== null) {
        const p = products[editingIndex];
        document.getElementById('field_nome').value = p.nome || '';
        document.getElementById('field_peso').value = p.peso || '';
        document.getElementById('field_local').value = p.localizacao || '';
        document.getElementById('field_codigo').value = p.codigo || '';
        document.getElementById('field_entrada').value = p.entrada || '';
        document.getElementById('field_validade').value = p.validade || '';
        document.getElementById('field_quantidade').value = p.quantidade || 0;
        document.getElementById('field_imagem').value = p.imagem || '';
      } else {
        document.getElementById('field_nome').value = '';
        document.getElementById('field_peso').value = '';
        document.getElementById('field_local').value = '';
        document.getElementById('field_codigo').value = '';
        document.getElementById('field_entrada').value = '';
        document.getElementById('field_validade').value = '';
        document.getElementById('field_quantidade').value = 1;
        document.getElementById('field_imagem').value = '';
      }
      document.getElementById('modalAdd').style.display = 'flex';
    }

    function closeAddModal() {
      document.getElementById('modalAdd').style.display = 'none';
      editingIndex = null;
    }

    function saveProduct() {
      const nome = document.getElementById('field_nome').value.trim();
      const peso = document.getElementById('field_peso').value.trim();
      const localizacao = document.getElementById('field_local').value.trim();
      const codigo = document.getElementById('field_codigo').value.trim();
      const entrada = document.getElementById('field_entrada').value;
      const validade = document.getElementById('field_validade').value;
      const quantidade = parseInt(document.getElementById('field_quantidade').value) || 0;
      const imagem = document.getElementById('field_imagem').value.trim();

      if (!nome) { alert('Nome é obrigatório'); return; }

      const novo = { id: uid('p'), nome, peso, localizacao, codigo, entrada, validade, quantidade, imagem };

      if (editingIndex !== null) {
        const beforeObj = { ...products[editingIndex] };
        products[editingIndex] = novo;
        addLogStructured('editar', `Editou lote do produto "${novo.nome}"`, beforeObj.quantidade, novo.quantidade, { before: beforeObj, after: novo });
        persistAll();
        renderProductList(currentSearch);
        closeAddModal();
        return;
      }

      const exactIndex = products.findIndex(p => p.nome === novo.nome && p.codigo === novo.codigo && p.localizacao === novo.localizacao);
      if (exactIndex >= 0) {
        const choice = confirm(`Já existe um produto com mesmo Nome + Código + Localização:\n${novo.nome} • ${novo.codigo} • ${novo.localizacao}\n\nDeseja somar a quantidade ao registro existente? (OK = Somar / Cancel = Criar novo)`);
        if (choice) {
          const before = products[exactIndex].quantidade || 0;
          products[exactIndex].quantidade = before + novo.quantidade;
          addLogStructured('merge', `Mesclou quantidades para "${novo.nome}"`, before, products[exactIndex].quantidade, { targetIndex: exactIndex });
          persistAll();
          renderProductList(currentSearch);
          closeAddModal();
          return;
        } else {
          products.push(novo);
          addLogStructured('novo', `Criou novo lote duplicado para "${novo.nome}"`, null, novo.quantidade, { new: novo });
          persistAll();
          renderProductList(currentSearch);
          closeAddModal();
          return;
        }
      }

      const similars = products.filter(p => p.nome === novo.nome && p.codigo === novo.codigo);
      if (similars.length > 0) {
        const want = confirm(`Encontrado(s) ${similars.length} lote(s) com mesmo Nome+Código em outras localizações.\nDeseja somar a um lote existente? (OK) ou criar novo (Cancelar)?`);
        if (want) {
          let msg = 'Escolha o número do lote para somar:\n';
          similars.forEach((s, i) => {
            msg += `${i + 1}) Local: ${s.localizacao || '-'} • qtd: ${s.quantidade || 0} • validade: ${s.validade || '-'}\n`;
          });
          const pick = prompt(msg + '\nDigite o número (1..' + similars.length + ') ou deixe em branco para cancelar:');
          const n = parseInt(pick);
          if (n >= 1 && n <= similars.length) {
            const sim = similars[n - 1];
            const globalIndex = products.findIndex(p => p.id === sim.id);
            if (globalIndex >= 0) {
              const before = products[globalIndex].quantidade || 0;
              products[globalIndex].quantidade = before + novo.quantidade;
              addLogStructured('merge_similar', `Somou ${novo.quantidade} ao lote existente de "${novo.nome}" (local ${products[globalIndex].localizacao})`, before, products[globalIndex].quantidade, { targetIndex: globalIndex });
              persistAll();
              renderProductList(currentSearch);
              closeAddModal();
              return;
            }
          }
        }
      }

      products.push(novo);
      addLogStructured('novo', `Adicionou novo produto "${novo.nome}"`, null, novo.quantidade, { new: novo });
      persistAll();
      renderProductList(currentSearch);
      closeAddModal();
    }

    function openDetails(index) {
      currentDetailProductIndex = index;
      const base = products[index];
      const same = products
        .map((p, i) => ({ ...p, __idx: i }))
        .filter(p => p.nome === base.nome && p.codigo === base.codigo)
        .sort((a, b) => {
          if (!a.validade) return 1;
          if (!b.validade) return -1;
          return new Date(a.validade) - new Date(b.validade);
        });

      const body = document.getElementById('modalDetailsBody');
      body.innerHTML = '';
      same.forEach(s => {
        const el = document.createElement('div');
        el.className = 'detail-row';
        el.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:800">${esc(s.nome)}</div>
          <div style="font-size:13px;color:var(--muted-text)">Local: ${esc(s.localizacao || '-')} • Código: ${esc(s.codigo || '-')}</div>
          <div style="font-size:13px;color:var(--muted-text)">Entrada: ${esc(s.entrada || '-')} • Validade: ${esc(s.validade || '-')}</div>
        </div>
        <div style="width:120px;text-align:center">
          <div style="font-weight:900;font-size:18px">${s.quantidade || 0}</div>
          <div style="display:flex;gap:6px;justify-content:center;margin-top:8px">
            <button class="btn btn-ghost" onclick="openAddModal(${s.__idx})">Editar</button>
            <button class="btn btn-warn" onclick="openSell(${s.__idx})">Vender</button>
          </div>
        </div>
      `;
        body.appendChild(el);
      });

      document.getElementById('modalDetails').style.display = 'flex';
    }

    function closeDetailsModal() {
      document.getElementById('modalDetails').style.display = 'none';
      currentDetailProductIndex = null;
    }

    function openSell(index) {
      sellingIndex = index;
      const p = products[index];
      document.getElementById('sellItemInfo').value = `${p.nome} • ${p.localizacao || '-'} • qtd: ${p.quantidade || 0}`;
      document.getElementById('sellQty').value = 1;
      document.getElementById('sellBuyer').value = '';
      document.getElementById('sellDoc').value = '';
      document.getElementById('modalSell').style.display = 'flex';
    }

    function closeSellModal() {
      document.getElementById('modalSell').style.display = 'none';
      sellingIndex = null;
    }

    function confirmSell() {
      const qty = parseInt(document.getElementById('sellQty').value) || 0;
      const buyer = document.getElementById('sellBuyer').value.trim() || 'Consumidor';
      const doc = document.getElementById('sellDoc').value.trim() || '';
      if (sellingIndex === null) { alert('Nenhum produto selecionado'); return; }
      const p = products[sellingIndex];
      if ((p.quantidade || 0) < qty) { alert('Quantidade insuficiente'); return; }
      const before = p.quantidade || 0;
      p.quantidade = before - qty;
      const sale = { id: uid('s'), produto: p.nome, quantidade: qty, comprador: buyer, doc, ts: new Date().toISOString(), productId: p.id };
      sales.unshift(sale);
      addLogStructured('venda', `Vendeu ${qty} de "${p.nome}" para ${buyer}`, before, p.quantidade, { saleId: sale.id });
      persistAll();
      renderProductList(currentSearch);
      updateAlertsAndSales();
      closeSellModal();
    }

    function exportCSV() {
      const rows = [['id', 'nome', 'peso', 'localizacao', 'codigo', 'entrada', 'validade', 'quantidade', 'imagem']];
      products.forEach(p => rows.push([p.id || '', p.nome || '', p.peso || '', p.localizacao || '', p.codigo || '', p.entrada || '', p.validade || '', p.quantidade || 0, p.imagem || '']));
      const csv = rows.map(r => r.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `vtz_produtos_${new Date().toISOString().slice(0, 10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function exportJSON() {
      const data = JSON.stringify({ products, logs, sales }, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `vtz_backup_${new Date().toISOString().slice(0, 10)}.json`; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function exportPDF() {
      // Simples: abrir nova janela com tabela e chamar print
      let html = `<html><head><title>Exportar PDF - VTZ</title><style>body{font-family:Arial,Helvetica,sans-serif;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:6px;text-align:left}</style></head><body>`;
      html += `<h2>Produtos VTZ — ${new Date().toLocaleString()}</h2>`;
      html += `<table><thead><tr><th>Nome</th><th>Local</th><th>Código</th><th>Qtd</th><th>Validade</th></tr></thead><tbody>`;
      products.forEach(p => {
        html += `<tr><td>${esc(p.nome)}</td><td>${esc(p.localizacao || '')}</td><td>${esc(p.codigo || '')}</td><td>${p.quantidade || 0}</td><td>${esc(p.validade || '')}</td></tr>`;
      });
      html += `</tbody></table></body></html>`;
      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      w.focus();
      // Give user chance to print
    }

    function exportLogsPDF() {
      // Cria o conteúdo HTML do PDF
      let html = `
      <html>
      <head>
        <title>Logs de Ações - VTZ</title>
        <style>
        body { font-family: Arial, Helvetica, sans-serif; padding: 20px; }
        h2 { color: #0b5e20; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 13px; }
        th { background-color: #e8f5e9; color: #0b5e20; }
      tr:nth-child(even) { background-color: #fafafa; }
      small { color: #666; }
    </style>
  </head>
  <body>
    <h2>📜 Logs de Ações — ${new Date().toLocaleString()}</h2>
    <table>
      <thead>
        <tr>
          <th>Data / Hora</th>
          <th>Usuário</th>
          <th>Tipo</th>
          <th>Mensagem</th>
          <th>Antes → Depois</th>
        </tr>
      </thead>
      <tbody>
  `;

      // Monta as linhas da tabela
      logs.forEach(l => {
        const beforeAfter =
          (l.before !== null || l.after !== null)
            ? `${l.before || ''} → ${l.after || ''}`
            : '';
        html += `
      <tr>
        <td>${new Date(l.ts).toLocaleString()}</td>
        <td>${l.user || '-'}</td>
        <td>${l.type || '-'}</td>
        <td>${l.message || '-'}</td>
        <td>${beforeAfter}</td>
      </tr>
    `;
      });

      html += `
      </tbody>
    </table>
  </body>
  </html>
  `;

      // Abre nova janela e imprime (gerando PDF)
      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }

    function logout() {
      localStorage.removeItem('vtz_user');
      location.reload();
    }

    function doLogin() {
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value;
      if (u === 'admin' && p === '1234') {
        localStorage.setItem('vtz_user', u);
        currentUser = u;
        document.getElementById('usuarioAtualHeader').value = u;
        document.getElementById('modalLoginOverlay').style.display = 'none';
        addLog('Login efetuado');
        renderProductList();
        renderLogs();
      } else {
        alert("Usuário ou senha inválidos!");
      }
    }

    function fillDemoLogin() {
      document.getElementById('loginUser').value = 'admin';
      document.getElementById('loginPass').value = '1234';
      doLogin();
    }

    function onSearch() {
      const v = document.getElementById('searchInput').value || '';
      currentSearch = v;
      renderProductList(v);
    }

    // allow changing user inline
    document.addEventListener('input', function (e) {
      if (e.target && e.target.id === 'usuarioAtualHeader') {
        currentUser = e.target.value.trim() || 'admin';
        localStorage.setItem('vtz_user', currentUser);
      }
    });

    // Init demo data if empty
    window.onload = function () {
      if (!products || products.length === 0) {
        products = [
          { id: uid('p'), nome: 'Nabo', peso: '10 KG', localizacao: 'N1', codigo: '725156365', entrada: '2023-07-02', validade: '2025-09-02', quantidade: 28, imagem: '' },
          { id: uid('p'), nome: 'TRIGO MOURISCO', peso: '05 KG', localizacao: 'S2', codigo: '78955332', entrada: '2023-07-02', validade: '2025-10-02', quantidade: 32, imagem: '' },
          { id: uid('p'), nome: 'BRACHIARIAS', peso: '10 KG', localizacao: 'S1', codigo: '56284587', entrada: '2023-07-02', validade: '2025-11-02', quantidade: 45, imagem: '' },
          { id: uid('p'), nome: 'Exemplo 2', peso: '50 Metros', localizacao: 'S3', codigo: 'EX002', entrada: '2024-02-10', validade: '2025-02-09', quantidade: 12, imagem: '' },
          { id: uid('p'), nome: 'Exemplo 3', peso: '05 KG', localizacao: 'S4', codigo: 'EX003', entrada: '2024-03-12', validade: '2025-09-02', quantidade: 3, imagem: '' },
        ];
        addLog(`Dados iniciais carregados (demo)`);
        persistAll();
      }

      // show login overlay if no user stored
      if (!localStorage.getItem('vtz_user')) {
        document.getElementById('modalLoginOverlay').style.display = 'flex';
      } else {
        currentUser = localStorage.getItem('vtz_user');
        document.getElementById('usuarioAtualHeader').value = currentUser;
      }

      renderProductList();
      renderLogs();
      updateDashboard();
      updateAlertsAndSales();
    }
    function previewProductImage(url) {
      const img = document.getElementById("previewImg");
      if (url && url.startsWith("http")) {
        img.src = url;
        img.style.display = "block";
      } else {
        img.style.display = "none";
      }
    }

    // Validação visual no Salvar
    const requiredFields = ["field_nome", "field_peso", "field_local", "field_codigo"];
    function validateFields() {
      let valid = true;
      requiredFields.forEach(id => {
        const input = document.getElementById(id);
        if (!input.value.trim()) {
          input.style.border = "2px solid #e74c3c";
          valid = false;
        } else {
          input.style.border = "1px solid #cfd8dc";
        }
      });
      return valid;
    }

    const oldSave = saveProduct;
    saveProduct = function () {
      if (!validateFields()) {
        alert("⚠️ Preencha todos os campos obrigatórios!");
        return;
      }
      oldSave();
    };

    // ---------------------------------------------
    // 📥 Baixar modelo Excel padrão
    // ---------------------------------------------
    function downloadExcelTemplate() {
      const wb = XLSX.utils.book_new();
      const wsData = [
        ["Nome", "Peso", "Localização", "Código", "Entrada", "Validade", "Quantidade", "Imagem"],
        ["Exemplo Produto", "10 KG", "N1", "123456", "2024-07-01", "2026-07-01", "50", "https://exemplo.com/imagem.jpg"]
      ];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "Modelo");
      XLSX.writeFile(wb, "Modelo_Estoque_VTZ.xlsx");
    }

    // ---------------------------------------------
    // 📤 Importar planilha Excel (.xlsx) com modal de revisão
    // ---------------------------------------------
    let importPreview = []; // guarda produtos importados + status temporário

    document.getElementById("excelInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const firstSheet = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheet];
        const json = XLSX.utils.sheet_to_json(worksheet);

        if (json.length === 0) {
          alert("⚠️ Nenhum dado encontrado no Excel.");
          return;
        }

        importPreview = json.map(row => {
          const novo = {
            id: uid('p'),
            nome: String(row.Nome || "").trim(),
            peso: String(row.Peso || "").trim(),
            localizacao: String(row.Localização || row.Local || "").trim(),
            codigo: String(row.Código || "").trim(),
            entrada: row.Entrada || "",
            validade: row.Validade || "",
            quantidade: parseInt(row.Quantidade) || 0,
            imagem: row.Imagem || ""
          };

          const existente = products.find(p =>
            p.nome === novo.nome &&
            p.codigo === novo.codigo &&
            p.validade === novo.validade &&
            p.localizacao === novo.localizacao &&
            p.peso === novo.peso
          );

          return {
            ...novo,
            duplicado: !!existente,
            existenteId: existente ? existente.id : null,
            action: existente ? "none" : "new" // 'sum', 'ignore', 'replace', 'new'
          };
        });

        renderImportModal();
      };

      reader.readAsArrayBuffer(file);
    });

    // ---------------------------------------------
    // 🪟 Renderiza modal de revisão
    // ---------------------------------------------
    function renderImportModal() {
      const tbody = document.querySelector("#importTable tbody");
      tbody.innerHTML = "";

      importPreview.forEach((p, idx) => {
        const row = document.createElement("tr");
        row.style.background = p.duplicado ? "#fff8e1" : "#e8f5e9";

        // texto de status
        let statusText = "✅ Novo";
        let actionButtons = "-";

        if (p.duplicado) {
          if (p.action === "sum") {
            statusText = "➕ Somando";
          } else if (p.action === "ignore") {
            statusText = "🚫 Ignorado";
          } else if (p.action === "replace") {
            statusText = "🔁 Substituído";
          } else {
            statusText = "⚠️ Duplicado";
          }

          const disabled = (a) => (p.action && p.action !== "none" && p.action !== a ? "disabled" : "");

          actionButtons = `
          <button class="btn btn-ghost" ${disabled("sum")} onclick="setImportAction(${idx},'sum')">
          ${p.action === "sum" ? "✅ Confirmado" : "➕ Somar"}
          </button>
          <button class="btn btn-ghost" ${disabled("ignore")} onclick="setImportAction(${idx},'ignore')">
          ${p.action === "ignore" ? "✅ Confirmado" : "🚫 Ignorar"}
          </button>
          <button class="btn btn-ghost" ${disabled("replace")} onclick="setImportAction(${idx},'replace')">
          ${p.action === "replace" ? "✅ Confirmado" : "🔁 Substituir"}
          </button>
        `;
        }

        row.innerHTML = `
        <td>${p.nome}</td>
        <td>${p.peso}</td>
        <td>${p.localizacao}</td>
        <td>${p.codigo}</td>
        <td>${p.validade}</td>
        <td>${p.quantidade}</td>
        <td>${statusText}</td>
        <td>${actionButtons}</td>
      `;
        tbody.appendChild(row);
      });

      document.getElementById("importModal").style.display = "flex";
    }

    function setImportAction(index, action) {
      importPreview[index].action = action;
      renderImportModal();
    }

    function closeImportModal() {
      if (confirm("Deseja cancelar a importação? Nenhuma alteração será aplicada.")) {
        importPreview = [];
        document.getElementById("importModal").style.display = "none";
      }
    }

    // ---------------------------------------------
    // ✅ Confirmar importação e aplicar no estoque
    // ---------------------------------------------
    function confirmImportChanges() {
      let importedCount = 0;
      let mergedCount = 0;
      let replacedCount = 0;

      importPreview.forEach(item => {
        if (item.duplicado) {
          const existente = products.find(p => p.id === item.existenteId);
          if (!existente) return;

          if (item.action === "sum") {
            const before = existente.quantidade;
            existente.quantidade += item.quantidade;
            mergedCount++;
            addLogStructured("merge_import", `Somou ${item.quantidade} unidades ao produto "${item.nome}"`, before, existente.quantidade, { produto: existente });
          } else if (item.action === "replace") {
            existente.quantidade = item.quantidade;
            existente.entrada = item.entrada;
            existente.validade = item.validade;
            existente.imagem = item.imagem;
            replacedCount++;
            addLogStructured("replace_import", `Substituiu dados do produto "${item.nome}"`, null, item.quantidade, { produto: existente });
          } // ignore = nada
        } else if (item.action === "new") {
          products.push(item);
          importedCount++;
          addLogStructured("novo_import", `Importou novo produto "${item.nome}" do Excel`, null, item.quantidade, { novo: item });
        }
      });

      persistAll();
      renderProductList();
      updateAlertsAndSales();
      document.getElementById("importModal").style.display = "none";

      alert(`✅ Importação concluída!
      🆕 Novos: ${importedCount}
      ➕ Somados: ${mergedCount}
      🔁 Substituídos: ${replacedCount}`);
    }

    // ---------------------------------------------
    // 🔎 Pesquisa inteligente com Fuse.js
    // ---------------------------------------------
    const fuseOptions = {
      keys: ['nome', 'codigo', 'localizacao', 'validade', 'peso'],
      threshold: 0.4,
    };

    function handleSearch() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        renderProductList(products);
        return;
      }

      const fuse = new Fuse(products, fuseOptions);
      const results = fuse.search(query).map(r => r.item);
      renderProductList(results);
    }

  </script>

</body>

</html>
